{% extends "base.html" %}


<!-- Static files for the ratings -->
{% block content %}
    <style type="text/css">
        .post-comments .comment-meta {
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
        }

        .post-comments .media {
            border-left: 1px dotted #000;
            border-bottom: 1px dotted #000;
            margin-bottom: 5px;
            padding-left: 10px;
        }

        .post-comments .media-heading {
            font-size: 12px;
            color: grey;
        }

        .post-comments .comment-meta a {
            font-size: 12px;
            color: grey;
            font-weight: bolder;
            margin-right: 5px;
        }

        h2 a, h2 a:hover {
            text-decoration: none;
            color: #333;
        }

        .about p {
            height: 70px;
            overflow: hidden;
        }

        h5, h6 {
            margin-left: 5px;
            margin-top: 3px;
            margin-bottom: 0px;
        }

        .topics ul li {
            color: #333;
        }
    </style>

    <div class="container-fluid">
        <div class="row-fluid">
            <div class="col-md-2"></div>
            <div class="col-md-7">
                <h2 style="float:left"><a target="_blank" href="{{ resource.url }}">{{ resource.name }}</a>&nbsp;&nbsp;</h2>
                <h3 style="float:left"><span class="label label-primary">{{ resource.get_type_display }}</span></h3>
                <h3 style="clear:both">from {{ resource.provider.name }}</h3>
            </div>
            <div class="col-md-3"></div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row-fluid">

            <!-- Covered Topics and Prerequisites -->
            <div class="col-md-2" style>
                <div class="topics" id="covered">
                    <h4>Covered Topics</h4>
                    <ul>
                        {% for covered in resource.covered_topics.all %}
                            <li>{{ covered.name }}</li>
                        {% endfor %}
                        <li>Add one</li>
                    </ul>
                </div>
                <div class="topics" id="prereqs">
                    <h4>Prerequisites</h4>
                    <ul>
                        {% for covered in resource.required_topics.all %}
                            <li>{{ covered.name }}</li>
                        {% endfor %}
                        <li>Add one</li>
                    </ul>
                </div>
            </div>

            <!-- Resource itself, meta-data and Discussion -->
            <div class="col-md-7 nopadding">
                {% with resource.get_embed_type_and_html as embed_info %}
                    {% if embed_info.0 == 'video' %}
                        <div class="embed-responsive embed-responsive-16by9">
                            {{ embed_info.1 | safe }}
                        </div>
                    {% else %}
                        {{ embed_info.1 | safe }}
                    {% endif %}
                {% endwith %}

                {% load ratings %}
                <h6 style="text-align:left">{% ratings resource %}</span></h6>
                <h4 style="text-align:right">{{ resource.views }} views</span></h4>

                <!-- Meta data -->
                <div class="about">
                    <p>
                        {{ resource.name }} was created by {{ resource.provider }} <br>
                        It should take about {{ resource.length }} time to get through <br>
                        The rest of this description is mostly just here for fun and testing <br>
                        Maybe some info about a more complicated rating and tags should go here. <br>
                        Maybe also some stuff about who uploaded it and some stats it has on the original site <br>
                        Or some useful links? Maybe users can vote on some good 'next resources' or something goofy <br>
                        idk. <br>
                    </p>
                </div>

                <h4>Discussion</h4>
                <div id="discussion" class="container-fluid">

                </div>
            </div>

            <div style="display: none;" id="comment-template">
                <div class="media">
                    <div class="media-heading"><button class="btn btn-default btn-xs" type="button" data-toggle="collapse" data-target="#$COLLAPSE_ID$" aria-expanded="false" aria-controls="collapseExample"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>&nbsp;<span class="label label-info">$DATETIME$</span><small> by $USERNAME$</small></div>
                    <div class="panel-collapse collapse in" id="$COLLAPSE_ID$">
                        <div class="media-left">
                            <div class="vote-wrap">
                                <div class="save-post"><a href="#"><span class="glyphicon glyphicon-star" aria-label="Save"></span></a></div>

                                {# <div class="vote up"><i class="glyphicon glyphicon-menu-up"></i></div><div class="vote inactive"><i class="glyphicon glyphicon-menu-down"></i></div>#}
                            </div>
                        </div>
                        <div class="my-son media-body">
                            <p>$COMMENTBODY$</p>
                            <div class="comment-meta">
                                {# functional links and reply etc. #}
                                <!--
                                <span><a class="" role="button" data-toggle="collapse" href="#$REPLY_THING_ID$" aria-expanded="false" aria-controls="collapseExample">reply</a></span>
                                <div class="collapse" id="$REPLY_THING_ID$">
                                    <form><div class="form-group"><label for="comment">Your Comment</label><textarea name="comment" class="form-control" rows="3"></textarea></div><button type="submit" class="btn btn-default">Send</button></form>
                                </div>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related Links -->
            <div class="col-md-3 nopadding">
                <h3>Related Links</h3>

                <div id="related-resources">

                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block pagescripts %}
    <script type="text/javascript">
        $(function () {

            // Add related links
            $.getJSON(Urls.related_resources_json(9), function(response) {
                var html = '';
                for(var i=0; i<response.length; i++) {
                    html += '<a href="' + Urls.resource_view(response[i].id) + '" class="list-group-item row" style="border-style: none">' ;
                    html += '<div class="col-xs-3 nopadding">' + response[i].imgHtml + '</div>';
                    html += '<div class="col-xs-9 nopadding">';
                    html += '<h5>' + response[i].name + '</h5>';
                    html += '<h6>' + response[i].provider + '</h6>';
                    html += '<h6>' + response[i].views + ' views</h6>';
                    html += '</div>';
                    html += '</div></a>';
                }

                $("#related-resources").html(html);
            });

            // Make about section toggleable height
            $(".about p").click(function() {
                console.log("I DUN GOT LCICKED");
                if ($(this).css("overflow") == 'hidden') {
                    $(this).attr("style", "overflow:visible; height:auto");
                } else {
                    $(this).attr("style", "overflow:hidden; height:70px");
                }
            });


            // Write comments in
            String.prototype.replaceAll = function(target, replacement) {
                return this.split(target).join(replacement);
            };

            var $commentTemplate = $("#comment-template").html();

            var postHTML = function(post) {
                var res = $commentTemplate;
                res = res.replaceAll('$USERNAME$', post.poster);
                res = res.replaceAll('$REPLY_THING_ID$', 'reply_thing_' + post.id);
                res = res.replaceAll('$COLLAPSE_ID$', 'collapse_cmt_' + post.id);
                res = res.replaceAll('$COMMENTBODY$', post.text);
                res = res.replaceAll('$DATETIME$', moment(post.time).format('MMMM Do YYYY \\a\\t h:mm:ss a'));
                return res;
            };

            $.getJSON(Urls.load_forum_posts({{ resource.pk }}), function (response) {
                html = '';

                $.each(response, function (_, thread) {
                    var $thread = $('<div>' + postHTML(thread) + '</div>');
                    var recurseChildren = function (children, dad) {
                        $.each(children, function (_, child) {
                            var $child = $('<div>' + postHTML(child) + '</div>');
                            dad.find('.my-son').first().append($child); // couldn't resist this line of code sry.
                            recurseChildren(child.children, $child);
                        });
                    };

                    recurseChildren(thread.children, $thread);

                    html += $thread.html();
                });


                $("#discussion").html(html);
            });
        })
    </script>
{% endblock %}
